<!doctype html><html lang=en-us><head><link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Debugging Python memory leaks with Heapy (Guppy) | uluwatu.xyz</title>
<link rel=canonical href=https://www.uluwatu.xyz/posts/debugging_memleaks_w_heapy/><meta name=description content="Specialising in the design and build of both high performance engineering and statistical analysis 
  applications for financial markets. Primarily focused on blockchain technologies and the Rust and Python programming languages."><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:url" content="https://www.uluwatu.xyz/posts/debugging_memleaks_w_heapy/"><meta property="og:site_name" content="uluwatu.xyz"><meta property="og:title" content="Debugging Python memory leaks with Heapy (Guppy)"><meta property="og:description" content="Introduction Guppy 1 is a python library containing among other things the heap debugging tool Heapy. This came in useful recently when attempting to debug a memory leak in a long running Python process. Large enterprises are rumoured to restart server processes every weekend to work around such issues, but we prefer a more scientific solution.
Unfortunately in the Python 3 port of Guppy the remote shell functionality for interactive debugging was disabled, although this would “stop the world” for other processing - not great for debugging production systems. To enable production profiling (as a last resort) we created a small utility class to write specific Guppy output to file on a schedule."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-02-06T12:13:03+00:00"><meta property="article:modified_time" content="2025-02-06T12:13:03+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Debugging Python memory leaks with Heapy (Guppy)"><meta name=twitter:description content="Introduction Guppy 1 is a python library containing among other things the heap debugging tool Heapy. This came in useful recently when attempting to debug a memory leak in a long running Python process. Large enterprises are rumoured to restart server processes every weekend to work around such issues, but we prefer a more scientific solution.
Unfortunately in the Python 3 port of Guppy the remote shell functionality for interactive debugging was disabled, although this would “stop the world” for other processing - not great for debugging production systems. To enable production profiling (as a last resort) we created a small utility class to write specific Guppy output to file on a schedule."><link rel=stylesheet href=https://www.uluwatu.xyz/css/styles.be8ee55377c08ec503dbdf705855cac5c3dc8ed2611600fa8ca9d0303a3273a6204c917e726a3ada7f61541307829b81ebbca651adaba3509bfd5d2074a5c93f.css integrity="sha512-vo7lU3fAjsUD299wWFXKxcPcjtJhFgD6jKnQMDoyc6YgTJF+cmo62n9hVBMHgpuB67ymUa2ro1Cb/V0gdKXJPw=="><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=https://www.uluwatu.xyz/images/favicon.ico></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><div id=header-post><a id=menu-icon href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=menu-icon-tablet href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=top-icon-tablet href=# onclick='$("html, body").animate({scrollTop:0},"fast")' style=display:none aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
<span id=menu><span id=nav><ul><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li></ul></span><br><span id=actions><ul><li><a class=icon href=https://www.uluwatu.xyz/posts/ic-tcost-hurdle-rates/ aria-label=Previous><i class="fas fa-chevron-left" aria-hidden=true onmouseover='$("#i-prev").toggle()' onmouseout='$("#i-prev").toggle()'></i></a></li><li><a class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up" aria-hidden=true onmouseover='$("#i-top").toggle()' onmouseout='$("#i-top").toggle()'></i></a></li><li><a class=icon href=# aria-label=Share><i class="fas fa-share-alt" aria-hidden=true onmouseover='$("#i-share").toggle()' onmouseout='$("#i-share").toggle()' onclick='return $("#share").toggle(),!1'></i></a></li></ul><span id=i-prev class=info style=display:none>Previous post</span>
<span id=i-next class=info style=display:none>Next post</span>
<span id=i-top class=info style=display:none>Back to top</span>
<span id=i-share class=info style=display:none>Share post</span></span><br><div id=share style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fwww.uluwatu.xyz%2fposts%2fdebugging_memleaks_w_heapy%2f" aria-label=Facebook><i class="fab fa-facebook" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fwww.uluwatu.xyz%2fposts%2fdebugging_memleaks_w_heapy%2f&text=Debugging%20Python%20memory%20leaks%20with%20Heapy%20%28Guppy%29" aria-label=Twitter><i class="fab fa-twitter" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fwww.uluwatu.xyz%2fposts%2fdebugging_memleaks_w_heapy%2f&title=Debugging%20Python%20memory%20leaks%20with%20Heapy%20%28Guppy%29" aria-label=Linkedin><i class="fab fa-linkedin" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fwww.uluwatu.xyz%2fposts%2fdebugging_memleaks_w_heapy%2f&is_video=false&description=Debugging%20Python%20memory%20leaks%20with%20Heapy%20%28Guppy%29" aria-label=Pinterest><i class="fab fa-pinterest" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=Debugging%20Python%20memory%20leaks%20with%20Heapy%20%28Guppy%29&body=Check out this article: https%3a%2f%2fwww.uluwatu.xyz%2fposts%2fdebugging_memleaks_w_heapy%2f" aria-label=Email><i class="fas fa-envelope" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fwww.uluwatu.xyz%2fposts%2fdebugging_memleaks_w_heapy%2f&title=Debugging%20Python%20memory%20leaks%20with%20Heapy%20%28Guppy%29" aria-label=Pocket><i class="fab fa-get-pocket" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fwww.uluwatu.xyz%2fposts%2fdebugging_memleaks_w_heapy%2f&title=Debugging%20Python%20memory%20leaks%20with%20Heapy%20%28Guppy%29" aria-label=reddit><i class="fab fa-reddit" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fwww.uluwatu.xyz%2fposts%2fdebugging_memleaks_w_heapy%2f&name=Debugging%20Python%20memory%20leaks%20with%20Heapy%20%28Guppy%29&description=%3ch1%20id%3d%22introduction%22%3eIntroduction%3c%2fh1%3e%0a%3cp%3eGuppy%20%3csup%20id%3d%22fnref%3a1%22%3e%3ca%20href%3d%22%23fn%3a1%22%20class%3d%22footnote-ref%22%20role%3d%22doc-noteref%22%3e1%3c%2fa%3e%3c%2fsup%3e%20is%20a%20python%20library%20containing%20among%20other%20things%20the%20heap%20debugging%20tool%20Heapy.%20This%20came%20in%20useful%20recently%20when%20attempting%20to%20debug%20a%20memory%20leak%20in%20a%20long%20running%20Python%20process.%20Large%20enterprises%20are%20rumoured%20to%20restart%20server%20processes%20every%20weekend%20to%20work%20around%20such%20issues%2c%20but%20we%20prefer%20a%20more%20scientific%20solution.%3c%2fp%3e%0a%3cp%3eUnfortunately%20in%20the%20Python%203%20port%20of%20Guppy%20the%20remote%20shell%20functionality%20for%20interactive%20debugging%20was%20disabled%2c%20although%20this%20would%20%26ldquo%3bstop%20the%20world%26rdquo%3b%20for%20other%20processing%20-%20not%20great%20for%20debugging%20production%20systems.%20To%20enable%20production%20profiling%20%28as%20a%20last%20resort%29%20we%20created%20a%20small%20utility%20class%20to%20write%20specific%20Guppy%20output%20to%20file%20on%20a%20schedule.%3c%2fp%3e" aria-label=Tumblr><i class="fab fa-tumblr" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fwww.uluwatu.xyz%2fposts%2fdebugging_memleaks_w_heapy%2f&t=Debugging%20Python%20memory%20leaks%20with%20Heapy%20%28Guppy%29" aria-label="Hacker News"><i class="fab fa-hacker-news" aria-hidden=true></i></a></li></ul></div><div id=toc><nav id=TableOfContents></nav></div></span></div><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">Debugging Python memory leaks with Heapy (Guppy)</h1><div class=meta><div class=postdate><time datetime="2025-02-06 12:13:03 +0000 UTC" itemprop=datePublished>2025-02-06</time></div><div class=article-read-time><i class="far fa-clock"></i>
5 minute read</div></div></header><div class=content itemprop=articleBody><h1 id=introduction>Introduction</h1><p>Guppy <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> is a python library containing among other things the heap debugging tool Heapy. This came in useful recently when attempting to debug a memory leak in a long running Python process. Large enterprises are rumoured to restart server processes every weekend to work around such issues, but we prefer a more scientific solution.</p><p>Unfortunately in the Python 3 port of Guppy the remote shell functionality for interactive debugging was disabled, although this would &ldquo;stop the world&rdquo; for other processing - not great for debugging production systems. To enable production profiling (as a last resort) we created a small utility class to write specific Guppy output to file on a schedule.</p><p>The Guppy output really requires interactive debugging, dumping pre-specified api interactions was slow and painful. we added a <code>pdb.set_trace()</code> option as a homage to the remote shell functionality, ultimately the ncurses nature of the application in question rendered this almost unusable also. We also investigated serialising the heapy snapshot with <code>pickle</code> but it was not trivial.</p><p>Alas, with some perseverance and some hardcoded Gappy api calls the memory leak was eventually found.</p><h1 id=the-code>The Code</h1><p>The utlity class is designed to be instantiated in a long running process and called frequently from a control loop (via <code>tick()</code>), if the required time has elapsed the utility will write a text representation of the snapshot to disk. It requires the Python library <code>gappy3</code>. The specific Gappy calls it makes are specific, hardcoded and ugly - it&rsquo;s an exercise for the reader to tune these as required.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Python data-lang=Python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>import</span> datetime
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#ff79c6>from</span> guppy <span style=color:#ff79c6>import</span> hpy
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#ff79c6>import</span> pdb<span style=color:#ff79c6>,</span> gc
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>hp <span style=color:#ff79c6>=</span> hpy()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#ff79c6>class</span> <span style=color:#50fa7b>HeapySnapshot</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#ff79c6>def</span> __init__(self, snapshot_interval: datetime<span style=color:#ff79c6>.</span>timedelta, 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>            drop_shell: <span style=color:#8be9fd;font-style:italic>bool</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>False</span>, refresh_snapshot: <span style=color:#8be9fd;font-style:italic>bool</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>False</span>):
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>        self<span style=color:#ff79c6>.</span>snapshot_interval <span style=color:#ff79c6>=</span> snapshot_interval
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        self<span style=color:#ff79c6>.</span>heap <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>None</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        self<span style=color:#ff79c6>.</span>last_snapshot <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>None</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        self<span style=color:#ff79c6>.</span>drop_shell <span style=color:#ff79c6>=</span> drop_shell
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        self<span style=color:#ff79c6>.</span>refresh_snapshot <span style=color:#ff79c6>=</span> refresh_snapshot
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    <span style=color:#ff79c6>def</span> <span style=color:#50fa7b>_generate_output_fn</span>(self):
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        <span style=color:#ff79c6>return</span> <span style=color:#f1fa8c>&#34;/tmp/heapy.log&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    <span style=color:#ff79c6>def</span> <span style=color:#50fa7b>_take_snapshot</span>(self):
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>        self<span style=color:#ff79c6>.</span>heap <span style=color:#ff79c6>=</span> hp<span style=color:#ff79c6>.</span>heap()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        self<span style=color:#ff79c6>.</span>last_snapshot <span style=color:#ff79c6>=</span> datetime<span style=color:#ff79c6>.</span>datetime<span style=color:#ff79c6>.</span>utcnow()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>    <span style=color:#ff79c6>def</span> <span style=color:#50fa7b>tick</span>(self):
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>        <span style=color:#ff79c6>if</span> self<span style=color:#ff79c6>.</span>heap <span style=color:#ff79c6>is</span> <span style=color:#ff79c6>None</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>            <span style=color:#ff79c6>return</span> self<span style=color:#ff79c6>.</span>_take_snapshot()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>        
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>        now <span style=color:#ff79c6>=</span> datetime<span style=color:#ff79c6>.</span>datetime<span style=color:#ff79c6>.</span>utcnow()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>        <span style=color:#ff79c6>if</span> now <span style=color:#ff79c6>-</span> self<span style=color:#ff79c6>.</span>last_snapshot <span style=color:#ff79c6>&gt;</span> self<span style=color:#ff79c6>.</span>snapshot_interval:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>            gc<span style=color:#ff79c6>.</span>collect()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>            delta <span style=color:#ff79c6>=</span> hp<span style=color:#ff79c6>.</span>heap() <span style=color:#ff79c6>-</span> self<span style=color:#ff79c6>.</span>heap
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>            <span style=color:#ff79c6>if</span> self<span style=color:#ff79c6>.</span>drop_shell:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>                pdb<span style=color:#ff79c6>.</span>set_trace()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>            <span style=color:#ff79c6>with</span> <span style=color:#8be9fd;font-style:italic>open</span>(self<span style=color:#ff79c6>.</span>_generate_output_fn(), <span style=color:#f1fa8c>&#34;a&#34;</span>) <span style=color:#ff79c6>as</span> fd:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>                fd<span style=color:#ff79c6>.</span>write(<span style=color:#8be9fd;font-style:italic>str</span>(delta<span style=color:#ff79c6>.</span>byrcs) <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>                fd<span style=color:#ff79c6>.</span>write(<span style=color:#8be9fd;font-style:italic>str</span>(delta[<span style=color:#bd93f9>0</span>]<span style=color:#ff79c6>.</span>byid[<span style=color:#bd93f9>0</span>]<span style=color:#ff79c6>.</span>shpaths) <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>                fd<span style=color:#ff79c6>.</span>write(<span style=color:#f1fa8c>&#34;==</span><span style=color:#f1fa8c>\n\n</span><span style=color:#f1fa8c>&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>            <span style=color:#ff79c6>if</span> self<span style=color:#ff79c6>.</span>refresh_snapshot:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>                self<span style=color:#ff79c6>.</span>_take_snapshot()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>            <span style=color:#ff79c6>else</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>                self<span style=color:#ff79c6>.</span>last_snapshot <span style=color:#ff79c6>=</span> datetime<span style=color:#ff79c6>.</span>datetime<span style=color:#ff79c6>.</span>utcnow()</span></span></code></pre></div><h1 id=consecutive-vs-cumulative-snapshot-deltas>Consecutive vs Cumulative snapshot deltas</h1><p>The initial investigation focused on analysing the delta between rolling snapshots (<em>refresh_snapshots</em>=True), ultimately this was
too noisey as it included expected allocations such as logger output and other objects which we expect to be garbage collected
shortly after. In this small sample size it was hard to pin-point the underlying issue.</p><p>Switching to taking cumulative snapshot deltas (ie. now vs. initial snapshot) proved much more valuable, the
expected short term allocations remained small over time and were utlimately dwarfed by the genuinely leaked object(s) as the sample size increased.</p><p>In this example, the top four items are all traced back to the single object which is leaked. In the output below more than 50% of the allocated memory can be traced to an <code>asyncio.Event</code> inside the object ultimately being leaked (confirmed via the omitted <code>shpaths</code> output). Specifically, the class variable <code>_waiters</code> (a queue) inside the <code>Event</code> is flagged as being the largest in size.</p><pre tabindex=0><code>Partition of a set of 274737 objects. Total size = 46022859 bytes.
 Index  Count   %     Size   % Cumulative  % Referrers by Kind (class / dict of class)
     0  39457  14 24621168  53  24621168  53 dict of asyncio.locks.Event
     1 114693  42  6752028  15  31373196  68 dict of &lt;LEAKED OBJECT&gt;
     2  39457  14  4103528   9  35476724  77 asyncio.locks.Event
     3  13152   5  3051264   7  38527988  84 &lt;LEAKED OBJECT&gt;
     4  26034   9  1512763   3  40040751  87 dict (no owner)
    ...
</code></pre><h1 id=why-is-the-size-of-asyncioevent-objects-so-large>Why is the size of asyncio.Event objects so large?</h1><p>It is curious that the <code>asyncio.Event</code> object dominated the allocated memory in terms of raw object size, especially when the containing (leaked) object contains strings and other objects - items I assumed would be more memory intensive than simple synchronisation logic.</p><p>We dive into the details, of <code>asyncio.Event</code> - a truncated representation is shown below. The high level process flow is that:</p><ul><li>Consumers invoke <code>wait()</code> which creates a future, adds it to <code>self._waiters</code> queue and blocks waiting for the future to finish.</li><li>When the event is &ldquo;set&rdquo;, we loop through each of the futures in <code>self._waiters</code> and mark them as complete, allowing the consumer to return and continue execution.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Python data-lang=Python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>class</span> <span style=color:#50fa7b>Event</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#ff79c6>def</span> __init__(self, <span style=color:#ff79c6>*</span>, loop<span style=color:#ff79c6>=</span>mixins<span style=color:#ff79c6>.</span>_marker):
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        <span style=color:#8be9fd;font-style:italic>super</span>()<span style=color:#ff79c6>.</span>__init__(loop<span style=color:#ff79c6>=</span>loop)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>        self<span style=color:#ff79c6>.</span>_waiters <span style=color:#ff79c6>=</span> collections<span style=color:#ff79c6>.</span>deque()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        self<span style=color:#ff79c6>.</span>_value <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>False</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#ff79c6>def</span> <span style=color:#50fa7b>set</span>(self):
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        <span style=color:#f1fa8c>&#34;&#34;&#34;Set the internal flag to true. All coroutines waiting for it to
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#f1fa8c>        become true are awakened. Coroutine that call wait() once the flag is
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#f1fa8c>        true will not block at all.
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#f1fa8c>        &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>not</span> self<span style=color:#ff79c6>.</span>_value:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>            self<span style=color:#ff79c6>.</span>_value <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>True</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>            <span style=color:#ff79c6>for</span> fut <span style=color:#ff79c6>in</span> self<span style=color:#ff79c6>.</span>_waiters:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>                <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>not</span> fut<span style=color:#ff79c6>.</span>done():
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>                    fut<span style=color:#ff79c6>.</span>set_result(<span style=color:#ff79c6>True</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    <span style=color:#ff79c6>async</span> <span style=color:#ff79c6>def</span> <span style=color:#50fa7b>wait</span>(self):
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>        <span style=color:#f1fa8c>&#34;&#34;&#34;Block until the internal flag is true.
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#f1fa8c>        If the internal flag is true on entry, return True
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#f1fa8c>        immediately.  Otherwise, block until another coroutine calls
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#f1fa8c>        set() to set the flag to true, then return True.
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#f1fa8c>        &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>        <span style=color:#ff79c6>if</span> self<span style=color:#ff79c6>.</span>_value:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>            <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>True</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>        fut <span style=color:#ff79c6>=</span> self<span style=color:#ff79c6>.</span>_get_loop()<span style=color:#ff79c6>.</span>create_future()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>        self<span style=color:#ff79c6>.</span>_waiters<span style=color:#ff79c6>.</span>append(fut)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>        <span style=color:#ff79c6>try</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>            <span style=color:#ff79c6>await</span> fut
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>            <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>True</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>        <span style=color:#ff79c6>finally</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>            self<span style=color:#ff79c6>.</span>_waiters<span style=color:#ff79c6>.</span>remove(fut)</span></span></code></pre></div><p>At a high level, this is relatively simple. In our specific scenario we must have a huge amount of consumers waiting on a single <code>Event</code> to finish? This doesn&rsquo;t immediately register as a valid use case in the application under investigation.</p><p>Next we examine the consumer of this specific object, which resides in a framework the application is relying on and understand the underlying issue:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Python data-lang=Python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>async</span> <span style=color:#ff79c6>def</span> <span style=color:#50fa7b>get_id</span>(self):
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    <span style=color:#ff79c6>if</span> self<span style=color:#ff79c6>.</span>id <span style=color:#ff79c6>is</span> <span style=color:#ff79c6>None</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>        <span style=color:#ff79c6>async</span> <span style=color:#ff79c6>with</span> timeout(TIMEOUT):
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>            <span style=color:#ff79c6>await</span> self<span style=color:#ff79c6>.</span>id_update_event<span style=color:#ff79c6>.</span>wait()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>    <span style=color:#ff79c6>return</span> self<span style=color:#ff79c6>.</span>id</span></span></code></pre></div><p>This <code>timeout()</code> wrapper cancels the <code>wait()</code> task after 10 seconds if it has not completed already, but nothing is removing the corresponding entry from <code>_waiters</code>. In an error state, where the <code>id</code> field in question is never set - we will continuously append orphaned futures to <code>_waiters</code>. If this object is important and polled continuously, we well generate a large enough number of orphaned waiters for it to stand out in terms of memory consumption.</p><p>This pattern is a pretty sub-optimal way to query a &ldquo;possibly yet to be updated&rdquo; value asynchronously, it fails to cater for the error case of the value never appearing and also blocks exection for up to 10 seconds waiting on every invocation.</p><p>Ultimately the <code>asyncio.Event</code> memory usage issue is a secondary one. Had the parent object not have leaked, it would have been removed by a &ldquo;Time To Live&rdquo; type logic, removing it&rsquo;s child Event from the scope of callers.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Guppy 3, <a href=https://zhuyifei1999.github.io/guppy3/>https://zhuyifei1999.github.io/guppy3/</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div></article><div id=footer-post-container><div id=footer-post><div id=nav-footer style=display:none><ul><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li></ul></div><div id=toc-footer style=display:none><nav id=TableOfContents></nav></div><div id=share-footer style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fwww.uluwatu.xyz%2fposts%2fdebugging_memleaks_w_heapy%2f" aria-label=Facebook><i class="fab fa-facebook fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fwww.uluwatu.xyz%2fposts%2fdebugging_memleaks_w_heapy%2f&text=Debugging%20Python%20memory%20leaks%20with%20Heapy%20%28Guppy%29" aria-label=Twitter><i class="fab fa-twitter fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fwww.uluwatu.xyz%2fposts%2fdebugging_memleaks_w_heapy%2f&title=Debugging%20Python%20memory%20leaks%20with%20Heapy%20%28Guppy%29" aria-label=Linkedin><i class="fab fa-linkedin fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fwww.uluwatu.xyz%2fposts%2fdebugging_memleaks_w_heapy%2f&is_video=false&description=Debugging%20Python%20memory%20leaks%20with%20Heapy%20%28Guppy%29" aria-label=Pinterest><i class="fab fa-pinterest fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=Debugging%20Python%20memory%20leaks%20with%20Heapy%20%28Guppy%29&body=Check out this article: https%3a%2f%2fwww.uluwatu.xyz%2fposts%2fdebugging_memleaks_w_heapy%2f" aria-label=Email><i class="fas fa-envelope fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fwww.uluwatu.xyz%2fposts%2fdebugging_memleaks_w_heapy%2f&title=Debugging%20Python%20memory%20leaks%20with%20Heapy%20%28Guppy%29" aria-label=Pocket><i class="fab fa-get-pocket fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fwww.uluwatu.xyz%2fposts%2fdebugging_memleaks_w_heapy%2f&title=Debugging%20Python%20memory%20leaks%20with%20Heapy%20%28Guppy%29" aria-label=reddit><i class="fab fa-reddit fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fwww.uluwatu.xyz%2fposts%2fdebugging_memleaks_w_heapy%2f&name=Debugging%20Python%20memory%20leaks%20with%20Heapy%20%28Guppy%29&description=%3ch1%20id%3d%22introduction%22%3eIntroduction%3c%2fh1%3e%0a%3cp%3eGuppy%20%3csup%20id%3d%22fnref%3a1%22%3e%3ca%20href%3d%22%23fn%3a1%22%20class%3d%22footnote-ref%22%20role%3d%22doc-noteref%22%3e1%3c%2fa%3e%3c%2fsup%3e%20is%20a%20python%20library%20containing%20among%20other%20things%20the%20heap%20debugging%20tool%20Heapy.%20This%20came%20in%20useful%20recently%20when%20attempting%20to%20debug%20a%20memory%20leak%20in%20a%20long%20running%20Python%20process.%20Large%20enterprises%20are%20rumoured%20to%20restart%20server%20processes%20every%20weekend%20to%20work%20around%20such%20issues%2c%20but%20we%20prefer%20a%20more%20scientific%20solution.%3c%2fp%3e%0a%3cp%3eUnfortunately%20in%20the%20Python%203%20port%20of%20Guppy%20the%20remote%20shell%20functionality%20for%20interactive%20debugging%20was%20disabled%2c%20although%20this%20would%20%26ldquo%3bstop%20the%20world%26rdquo%3b%20for%20other%20processing%20-%20not%20great%20for%20debugging%20production%20systems.%20To%20enable%20production%20profiling%20%28as%20a%20last%20resort%29%20we%20created%20a%20small%20utility%20class%20to%20write%20specific%20Guppy%20output%20to%20file%20on%20a%20schedule.%3c%2fp%3e" aria-label=Tumblr><i class="fab fa-tumblr fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fwww.uluwatu.xyz%2fposts%2fdebugging_memleaks_w_heapy%2f&t=Debugging%20Python%20memory%20leaks%20with%20Heapy%20%28Guppy%29" aria-label="Hacker News"><i class="fab fa-hacker-news fa-lg" aria-hidden=true></i></a></li></ul></div><div id=actions-footer><a id=menu-toggle class=icon href=# onclick='return $("#nav-footer").toggle(),!1' aria-label=Menu><i class="fas fa-bars fa-lg" aria-hidden=true></i> Menu</a>
<a id=toc-toggle class=icon href=# onclick='return $("#toc-footer").toggle(),!1' aria-label=TOC><i class="fas fa-list fa-lg" aria-hidden=true></i> TOC</a>
<a id=share-toggle class=icon href=# onclick='return $("#share-footer").toggle(),!1' aria-label=Share><i class="fas fa-share-alt fa-lg" aria-hidden=true></i> share</a>
<a id=top style=display:none class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg" aria-hidden=true></i> Top</a></div></div></div><footer id=footer><div class=footer-left>Copyright &copy; 2025 Uluwatu.xyz 2024</div><div class=footer-right><nav><ul><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li></ul></nav></div></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script><script src=/js/main.js></script><script src=/js/code-copy.js></script></html>